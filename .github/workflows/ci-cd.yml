name: CI/CD Pipeline

on:
  push:
    tags: ['v*']        # Solo en tags de release
  pull_request:
    branches: [main]    # Solo PRs a main
  workflow_dispatch:    # Ejecuci√≥n manual

# Cancelar builds duplicados
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.14.0'

jobs:
  build:
    name: Build & Quality Check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" =~ refs/tags/v(.+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract section for this version
          awk -v ver="$VERSION" '/^## \[/{if(p){exit}; if($0 ~ "## \\[" ver "\\]"){p=1; next}} p' CHANGELOG.md > release_notes.txt
          
          if [ ! -s release_notes.txt ]; then
            echo "Release v$VERSION" > release_notes.txt
          fi
          
          echo "Release notes extracted:"
          cat release_notes.txt
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # Cache node_modules para ahorrar ~2 minutos
      - name: Cache node modules
        uses: actions/cache@v4
        id: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-node-v1-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-v1-
      
      # Cache Playwright browsers para ahorrar ~1 minuto (500MB aprox)
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: cache-playwright
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-v1-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-v1-
      
      # Cache Wine para ahorrar ~1-2 minutos en instalaci√≥n
      - name: Cache Wine installation
        uses: actions/cache@v4
        id: cache-wine
        with:
          path: |
            /opt/wine-stable
            ~/.wine
          key: ${{ runner.os }}-wine-v1-9.0
          restore-keys: |
            ${{ runner.os }}-wine-v1-
      
      - name: Install Wine and dependencies
        if: steps.cache-wine.outputs.cache-hit != 'true'
        run: |
          sudo dpkg --add-architecture i386
          sudo mkdir -pm755 /etc/apt/keyrings
          sudo wget -O /etc/apt/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
          sudo wget -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/winehq-jammy.sources
          sudo apt-get update
          sudo apt-get install -y --install-recommends winehq-stable
      
      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci
      
      - name: Install Playwright browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps
      
      # CR√çTICO: Copiar binarios de Playwright a node_modules para asarUnpack
      - name: Copy Playwright binaries to node_modules
        run: |
          echo "üì¶ Copiando binarios de Playwright a node_modules..."
          mkdir -p node_modules/playwright/.local-browsers
          
          # Copiar desde cache de Playwright
          if [ -d "$HOME/.cache/ms-playwright" ]; then
            cp -r $HOME/.cache/ms-playwright/chromium-* node_modules/playwright/.local-browsers/ 2>/dev/null || true
          fi
          
          # Verificar
          if [ -d "node_modules/playwright/.local-browsers/chromium-"* ]; then
            echo "‚úÖ Binarios copiados correctamente"
            ls -lah node_modules/playwright/.local-browsers/
          else
            echo "‚ùå ERROR: No se pudieron copiar los binarios"
            exit 1
          fi
      
      - name: Run quality checks
        run: npm run validate
      
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Package application (Windows)
        run: npx electron-builder --win --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      # Verificar que node_modules/playwright qued√≥ desempaquetado
      - name: Verify packaged Playwright (asarUnpack)
        run: |
          echo "üì¶ Verificando recursos empaquetados..."
          
          if [ -d "release/win-unpacked/resources" ]; then
            echo "‚úÖ Carpeta resources encontrada"
            ls -lah release/win-unpacked/resources/
            
            if [ -d "release/win-unpacked/resources/app.asar.unpacked" ]; then
              echo ""
              echo "‚úÖ app.asar.unpacked encontrado"
              
              if [ -d "release/win-unpacked/resources/app.asar.unpacked/node_modules/playwright" ]; then
                echo "‚úÖ Playwright desempaquetado correctamente"
                echo ""
                echo "üìÇ Buscando chrome.exe:"
                find release/win-unpacked/resources/app.asar.unpacked/node_modules/playwright -name "chrome.exe" -type f || echo "‚ö†Ô∏è  chrome.exe no encontrado (se descargar√° al ejecutar)"
              else
                echo "‚ùå ERROR: node_modules/playwright NO encontrado en app.asar.unpacked"
                ls -lah release/win-unpacked/resources/app.asar.unpacked/node_modules/ || echo "node_modules no existe"
                exit 1
              fi
            else
              echo "‚ùå ERROR: app.asar.unpacked NO encontrado en resources"
              echo "Contenido de resources:"
              ls -lah release/win-unpacked/resources/
              exit 1
            fi
          else
            echo "‚ùå ERROR: Carpeta resources no encontrada"
            exit 1
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            release/*.exe
            release/*.blockmap
            release/*.yml
            release_notes.txt
          retention-days: 1  # Eliminar despu√©s de 1 d√≠a para $0 storage

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
      
      - name: List downloaded files
        run: |
          echo "=== Downloaded files ==="
          ls -lah
          find . -type f
      
      - name: Read release notes
        id: notes
        run: |
          if [ -f release_notes.txt ]; then
            {
              echo 'notes<<EOF'
              cat release_notes.txt
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "notes=Release v${{ needs.build.outputs.version }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Replicon Automator v${{ needs.build.outputs.version }}
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            release/*.exe
            release/*.blockmap
            release/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
