name: Cleanup Storage (Free Tier Optimization)

# Este workflow limpia autom√°ticamente artifacts y caches antiguos
# para garantizar $0 de consumo de storage en cuentas gratuitas

on:
  # Ejecutar cada 6 horas para limpieza agresiva
  schedule:
    - cron: '0 */6 * * *'
  # Ejecutar despu√©s de cada workflow completado
  workflow_run:
    workflows: ["CI/CD Pipeline", "Test Coverage Report"]
    types:
      - completed
  # Ejecutar autom√°ticamente despu√©s de cada push
  push:
    branches: [main]
  # Permitir ejecuci√≥n manual
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup-artifacts:
    name: Delete Old Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Delete artifacts (all if manual, old if automatic)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const isManual = context.eventName === 'workflow_dispatch';
            
            // Obtener todos los artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            const sixHoursAgo = new Date(Date.now() - 6 * 60 * 60 * 1000);
            let deletedCount = 0;
            
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              
              // Si es manual, borrar TODO. Si es autom√°tico, solo > 6 horas
              const shouldDelete = isManual || createdAt < sixHoursAgo;
              
              if (shouldDelete) {
                console.log(`üóëÔ∏è  Eliminando artifact: ${artifact.name} (${artifact.size_in_bytes} bytes, creado: ${artifact.created_at})`);
                
                await github.rest.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: artifact.id
                });
                
                deletedCount++;
              }
            }
            
            if (isManual) {
              console.log(`üö® LIMPIEZA MANUAL: Todos los artifacts eliminados`);
            }
            console.log(`‚úÖ Artifacts eliminados: ${deletedCount}`);
            console.log(`üìä Artifacts restantes: ${artifacts.data.total_count - deletedCount}`);

  cleanup-caches:
    name: Delete Unused Caches
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup caches (all if manual, old if automatic)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const isManual = context.eventName === 'workflow_dispatch';
            
            // Obtener todos los caches
            const caches = await github.rest.actions.getActionsCacheList({
              owner,
              repo,
              per_page: 100
            });
            
            const oneHourAgo = new Date(Date.now() - 1 * 60 * 60 * 1000);
            let deletedCount = 0;
            let freedSpace = 0;
            
            for (const cache of caches.data.actions_caches) {
              const lastAccessed = new Date(cache.last_accessed_at);
              
              // Si es manual, borrar TODO. Si es autom√°tico, aplicar reglas
              const shouldDelete = isManual || 
                lastAccessed < oneHourAgo ||
                new Date(cache.created_at) < new Date(Date.now() - 6 * 60 * 60 * 1000);
              
              if (shouldDelete) {
                console.log(`üóëÔ∏è  Eliminando cache: ${cache.key} (${(cache.size_in_bytes / 1024 / 1024).toFixed(2)} MB, √∫ltimo acceso: ${cache.last_accessed_at})`);
                
                await github.rest.actions.deleteActionsCacheById({
                  owner,
                  repo,
                  cache_id: cache.id
                });
                
                deletedCount++;
                freedSpace += cache.size_in_bytes;
              }
            }
            
            if (isManual) {
              console.log(`üö® LIMPIEZA MANUAL: Todos los caches eliminados`);
            }
            console.log(`‚úÖ Caches eliminados: ${deletedCount}`);
            console.log(`üíæ Espacio liberado: ${(freedSpace / 1024 / 1024 / 1024).toFixed(2)} GB`);

  report-storage:
    name: Report Storage Usage
    runs-on: ubuntu-latest
    needs: [cleanup-artifacts, cleanup-caches]
    steps:
      - name: Get storage usage statistics
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            let totalArtifactsSize = 0;
            for (const artifact of artifacts.data.artifacts) {
              totalArtifactsSize += artifact.size_in_bytes;
            }
            
            // Caches
            const caches = await github.rest.actions.getActionsCacheList({
              owner,
              repo,
              per_page: 100
            });
            
            let totalCachesSize = 0;
            for (const cache of caches.data.actions_caches) {
              totalCachesSize += cache.size_in_bytes;
            }
            
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìä REPORTE DE ALMACENAMIENTO');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log(`üì¶ Artifacts: ${artifacts.data.total_count} archivos`);
            console.log(`   Tama√±o: ${(totalArtifactsSize / 1024 / 1024).toFixed(2)} MB`);
            console.log('');
            console.log(`üíæ Caches: ${caches.data.actions_caches.length} entradas`);
            console.log(`   Tama√±o: ${(totalCachesSize / 1024 / 1024).toFixed(2)} MB`);
            console.log('');
            console.log(`üìà Total: ${((totalArtifactsSize + totalCachesSize) / 1024 / 1024).toFixed(2)} MB`);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Advertir si el storage es mayor a 500 MB
            const totalMB = (totalArtifactsSize + totalCachesSize) / 1024 / 1024;
            if (totalMB > 500) {
              console.log('‚ö†Ô∏è  ADVERTENCIA: Storage > 500 MB');
              console.log('   Considera reducir retenci√≥n o cache');
            } else if (totalMB < 100) {
              console.log('‚úÖ Storage optimizado (<100 MB)');
            }
