name: CI/CD Pipeline

on:
  push:
    tags: ['v*']        # Solo en tags de release
  pull_request:
    branches: [main]    # Solo PRs a main
  workflow_dispatch:    # EjecuciÃ³n manual

# Cancelar builds duplicados
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.14.0'

jobs:
  build:
    name: Build & Quality Check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" =~ refs/tags/v(.+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract section for this version
          awk "/^## \[${VERSION}\]/,/^## \[/" CHANGELOG.md | head -n -1 | tail -n +2 > release_notes.txt
          
          if [ ! -s release_notes.txt ]; then
            echo "Release v$VERSION" > release_notes.txt
          fi
          
          echo "Release notes extracted:"
          cat release_notes.txt
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # Cache node_modules para ahorrar ~2 minutos
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      # Cache Playwright browsers para ahorrar ~1 minuto
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      
      - name: Install Wine and dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo mkdir -pm755 /etc/apt/keyrings
          sudo wget -O /etc/apt/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
          sudo wget -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/winehq-jammy.sources
          sudo apt-get update
          sudo apt-get install -y --install-recommends winehq-stable
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Run quality checks
        run: npm run validate
      
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Copy Playwright binaries
        run: npm run copy-playwright-bins
      
      - name: Package application (Windows)
        run: npx electron-builder --win --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            release/*.exe
            release/*.blockmap
            release/*.yml
            release_notes.txt
          retention-days: 30  # Ahorro de storage

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
      
      - name: List downloaded files
        run: |
          echo "=== Downloaded files ==="
          ls -lah
          find . -type f
      
      - name: Read release notes
        id: notes
        run: |
          if [ -f release_notes.txt ]; then
            {
              echo 'notes<<EOF'
              cat release_notes.txt
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "notes=Release v${{ needs.build.outputs.version }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Replicon Automator v${{ needs.build.outputs.version }}
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            release/*.exe
            release/*.blockmap
            release/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
