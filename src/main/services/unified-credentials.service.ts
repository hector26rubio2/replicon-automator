import { safeStorage } from 'electron';import Store from 'electron-store';import type { Credentials } from '../../shared/types';import { createLogger } from '../utils';const logger = createLogger('CredentialsService');const store = new Store<{  credentials?: {    email: string;    password: string;    rememberMe: boolean;    encrypted: boolean;  };}>({  name: 'secure-credentials-v2',});export function isEncryptionAvailable(): boolean {  try {    return safeStorage.isEncryptionAvailable();  } catch {    return false;  }}function encryptString(value: string): string {  if (isEncryptionAvailable()) {    return safeStorage.encryptString(value).toString('base64');  }  return Buffer.from(value).toString('base64');}function decryptString(encrypted: string, wasEncrypted: boolean): string {  if (wasEncrypted && isEncryptionAvailable()) {    const buffer = Buffer.from(encrypted, 'base64');    return safeStorage.decryptString(buffer);  }  return Buffer.from(encrypted, 'base64').toString('utf-8');}export function saveCredentials(credentials: Credentials): boolean {  try {    if (!credentials.rememberMe) {      clearCredentials();      return true;    }    const encrypted = isEncryptionAvailable();    store.set('credentials', {      email: encryptString(credentials.email),      password: encryptString(credentials.password),      rememberMe: true,      encrypted,    });    logger.info(`Credentials saved (encrypted: ${encrypted})`);    return true;  } catch (error) {    logger.error('Error saving credentials', error);    return false;  }}export function loadCredentials(): Credentials | null {  try {    const saved = store.get('credentials');    if (!saved) return null;    return {      email: decryptString(saved.email, saved.encrypted),      password: decryptString(saved.password, saved.encrypted),      rememberMe: saved.rememberMe,    };  } catch (error) {    logger.error('Error loading credentials', error);    clearCredentials();    return null;  }}export function clearCredentials(): boolean {  try {    store.delete('credentials');    logger.info('Credentials cleared');    return true;  } catch (error) {    logger.error('Error clearing credentials', error);    return false;  }}export function hasCredentials(): boolean {  return store.has('credentials');}export async function migrateCredentials(): Promise<void> {  try {    const oldStore = new Store({ name: 'credentials' });    const oldCreds = oldStore.get('credentials') as {      email: string;      password: string;      rememberMe: boolean;    } | undefined;    if (oldCreds && !hasCredentials()) {      const password = Buffer.from(oldCreds.password, 'base64').toString('utf-8');      saveCredentials({        email: oldCreds.email,        password,        rememberMe: oldCreds.rememberMe,      });      oldStore.delete('credentials');      logger.info('Migrated credentials to new secure format');    }  } catch (error) {    logger.warn('Could not migrate old credentials', error);  }}export class CredentialsService {  saveCredentials = (creds: Credentials) => saveCredentials(creds);  loadCredentials = () => loadCredentials();  clearCredentials = () => clearCredentials();  hasCredentials = () => hasCredentials();  isEncryptionAvailable = () => isEncryptionAvailable();}export const credentialsService = new CredentialsService();